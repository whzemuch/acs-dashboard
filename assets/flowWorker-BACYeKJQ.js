(function(){"use strict";const _={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_MAPBOX_TOKEN:"pk.eyJ1Ijoid2h6ZW11Y2giLCJhIjoiY21mNW1veXJuMDNzYzJsb21jOXZkb3Y5cyJ9.hP6BD6HV9rrR4NlzWt3DVA"},h=typeof{url:self.location.href}<"u"&&_&&"./"||"/",n={config:{...{countyMetaUrl:`${h}data/cache/county-metadata.json`,yearsUrl:`${h}data/cache/years.json`,flowUrl:t=>`${h}data/cache/flows/${t}.json`,dimensionsUrl:`${h}data/cache/dimensions.json`,maxArcs:200}},initPromise:null,years:[],dimensions:null,countyMetadata:[],countyById:new Map,countiesByState:new Map,flowsByYear:new Map,memoizedSelectors:new Map};async function p(){return n.initPromise||(n.initPromise=(async()=>{const[t,i,a]=await Promise.all([w(n.config.yearsUrl),w(n.config.countyMetaUrl),w(n.config.dimensionsUrl).catch(()=>null)]);n.years=t,n.countyMetadata=i,n.dimensions=a,i.forEach(s=>{n.countyById.set(s.geoid,s),n.countiesByState.has(s.state)||n.countiesByState.set(s.state,[]),n.countiesByState.get(s.state).push(s.geoid)})})()),n.initPromise}async function M(t){if(await p(),n.flowsByYear.has(t))return;const i=typeof n.config.flowUrl=="function"?n.config.flowUrl(t):n.config.flowUrl,a=await w(i);n.flowsByYear.set(t,a);for(const s of n.memoizedSelectors.keys())s.includes(`"${t}"`)&&n.memoizedSelectors.delete(s)}async function j(t={}){const i=await B(t),a=JSON.stringify(i);if(n.memoizedSelectors.has(a))return n.memoizedSelectors.get(a);const{year:s}=i,o=n.flowsByYear.get(s);if(!o)return[];const c=F(o,i);return n.memoizedSelectors.set(a,c),c}async function B(t){await p();const{year:i=n.years[n.years.length-1],metric:a="net",minFlow:s=0,topN:o=n.config.maxArcs,threshold:c=null,state:f=null,county:l=null,age:u=null,income:m=null,education:P=null}=t;return await M(i),{year:i,metric:a,minFlow:s,topN:o,threshold:c,state:f,county:l,age:u,income:m,education:P}}function F(t,i){const{metric:a,minFlow:s,topN:o,state:c,county:f,age:l,income:u,education:m}=i;let r=t.rows??[];if(l&&l!=="all"&&(r=r.filter(e=>e.age===l)),u&&u!=="all"&&(r=r.filter(e=>e.income===u)),m&&m!=="all"&&(r=r.filter(e=>e.education===m)),c){const e=new Set(n.countiesByState.get(c)??[]);r=r.filter(y=>e.has(y.origin)||e.has(y.dest))}if(f){const e=String(f).padStart(5,"0");if(a==="in")r=t.inAdjacency?.[e]??[];else if(a==="out")r=t.outAdjacency?.[e]??[];else{const y=t.inAdjacency?.[e]??[],z=t.outAdjacency?.[e]??[];r=[...y,...z]}}let g=r.filter(e=>e.flow>=s);return g.sort((e,y)=>y.flow-e.flow),typeof o=="number"&&o>0&&(g=g.slice(0,o)),g.map(e=>({id:`${e.year}-${e.origin}-${e.dest}-${e.age??"any"}-${e.income??"any"}-${e.education??"any"}`,year:e.year,origin:e.origin,dest:e.dest,flow:e.flow,originPosition:[e.originLon,e.originLat],destPosition:[e.destLon,e.destLat],age:e.age,income:e.income,education:e.education}))}async function w(t){const i=/^https?:/i.test(t),a=typeof process<"u"&&typeof process.cwd=="function";if(typeof window>"u"&&!i&&a){const{readFile:s}=await Promise.resolve().then(function(){return d}),o=await Promise.resolve().then(function(){return d}),c=t.startsWith("/")?t.slice(1):t,f=o.join(process.cwd(),"public",c),l=await s(f,"utf8");return JSON.parse(l)}if(typeof fetch=="function")try{const s=await fetch(t);if(!s.ok)throw new Error(`Failed to fetch ${t}: ${s.status}`);return await s.json()}catch(s){if(!i&&a){const{readFile:o}=await Promise.resolve().then(function(){return d}),c=await Promise.resolve().then(function(){return d}),f=t.startsWith("/")?t.slice(1):t,l=c.join(process.cwd(),"public",f),u=await o(l,"utf8");return JSON.parse(u)}throw s}if(a){const{readFile:s}=await Promise.resolve().then(function(){return d}),o=await Promise.resolve().then(function(){return d}),c=t.startsWith("/")?t.slice(1):t,f=o.join(process.cwd(),"public",c),l=await s(f,"utf8");return JSON.parse(l)}throw new Error(`No fetch implementation available for ${t}`)}let S=!1;async function $(){S||(await p(),S=!0)}self.onmessage=async t=>{const{id:i,type:a,payload:s}=t.data||{};try{if(await $(),a==="getFlows"){const o=await j(s);self.postMessage({id:i,success:!0,result:o});return}throw new Error(`Unknown message type: ${a}`)}catch(o){self.postMessage({id:i,success:!1,error:o instanceof Error?o.message:String(o)})}};var d=Object.freeze({__proto__:null})})();
